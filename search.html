<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EV 生活圈 - 充電與美食導航</title>
    <!-- 引入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 FontAwesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- 引入 Noto Sans Font (美食單元使用) -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        /* 共用動畫 */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* EV 充電單元專用樣式 */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #10B981;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 美食單元專用樣式 */
        .category-scroll {
            display: flex;
            overflow-x: auto;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .category-scroll::-webkit-scrollbar { display: none; }
        
        .food-select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=utf-8,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3E%3Cpath stroke='%23ea580c' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3E%3C/svg%3E");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 1.5em 1.5em;
            padding-right: 2.0rem;
        }

        /* 底部導航列安全區設定 (避免 iPhone Home Bar 遮擋) */
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 font-sans h-screen overflow-hidden flex flex-col">

    <!-- ========================================== -->
    <!-- 視圖 1: EV 充電站導航 (保留原始功能) -->
    <!-- ========================================== -->
    <div id="view-ev" class="flex-1 overflow-y-auto pb-20 relative">
        <!-- 頂部導航列 (EV) -->
        <header class="bg-white shadow-sm sticky top-0 z-40">
            <div class="max-w-md mx-auto px-4 py-4 flex justify-between items-center">
                <h1 class="text-xl font-bold text-gray-800">
                    <i class="fas fa-charging-station text-green-500 mr-2"></i>EV 充電神探
                </h1>
                <div class="text-xs text-gray-500 bg-gray-100 px-2 py-1 rounded-full">
                    <i class="fas fa-wifi mr-1"></i>線上
                </div>
            </div>
        </header>

        <!-- 主要內容區 (EV) -->
        <main class="max-w-md mx-auto px-4 py-6">
            <!-- 狀態面板 -->
            <div class="bg-gradient-to-r from-green-500 to-emerald-600 rounded-2xl p-6 text-white shadow-lg mb-6 text-center">
                <p class="text-sm opacity-90 mb-1">目前位置狀態</p>
                <h2 id="status-text" class="text-2xl font-bold mb-4">準備就緒</h2>
                
                <button id="locate-btn" onclick="startLocationProcess()" 
                    class="bg-white text-green-600 hover:bg-green-50 font-bold py-3 px-8 rounded-full shadow-md transition transform hover:scale-105 active:scale-95 w-full flex items-center justify-center gap-2">
                    <i class="fas fa-location-arrow"></i> 搜尋附近充電站
                </button>
                
                <!-- 錯誤訊息容器 -->
                <div id="error-container" class="hidden mt-4 bg-red-500/20 rounded-lg p-3 backdrop-blur-sm border border-red-200/30">
                    <p id="error-msg" class="text-white text-sm font-medium mb-2"></p>
                    <div class="flex gap-2 justify-center">
                        <button onclick="useDefaultLocation()" class="text-xs bg-white text-red-600 px-3 py-1 rounded shadow hover:bg-gray-100 transition">
                            <i class="fas fa-map-pin mr-1"></i> 強制使用預設位置
                        </button>
                    </div>
                </div>
            </div>

            <!-- 結果列表容器 -->
            <div id="result-container" class="space-y-4 hidden">
                <div class="flex justify-between items-center px-1">
                    <h3 class="font-bold text-gray-700">推薦站點 (依距離排序)</h3>
                    <span class="text-xs text-gray-500">來源: 模擬數據</span>
                </div>
                <div id="station-list"></div>
            </div>

            <!-- 初始畫面指引 -->
            <div id="empty-state" class="text-center py-10 text-gray-400">
                <i class="fas fa-map-marked-alt text-6xl mb-4 text-gray-300"></i>
                <p>點擊上方按鈕<br>找出各時段最佳充電站</p>
            </div>
        </main>
    </div>

    <!-- ========================================== -->
    <!-- 視圖 2: 美食決策導航 (新功能) -->
    <!-- ========================================== -->
    <div id="view-food" class="hidden flex-1 flex flex-col bg-[#f3f4f6] relative overflow-hidden">
        <!-- Header (Food) -->
        <header class="bg-gradient-to-r from-orange-500 to-red-600 text-white p-4 shadow-lg flex-none z-10">
            <div class="max-w-2xl mx-auto w-full flex flex-col gap-3">
                <div class="flex justify-between items-center">
                    <h1 class="text-xl font-bold flex items-center">
                        <i class="fas fa-utensils mr-2"></i>美食決策導航
                    </h1>
                    <button onclick="initApp()" class="bg-white/20 hover:bg-white/30 active:scale-95 transition rounded-full p-2 w-10 h-10 flex items-center justify-center" title="重新定位與搜尋">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                </div>
                
                <!-- Filter Bar -->
                <div class="flex flex-wrap items-center justify-between bg-white/10 backdrop-blur-sm rounded-lg p-2 px-3 border border-white/20 gap-2">
                    <div class="flex items-center space-x-2">
                        <label for="rating-select" class="text-sm font-medium text-white/90 whitespace-nowrap">
                            <i class="fas fa-star text-yellow-300 mr-1"></i>評分
                        </label>
                        <select id="rating-select" onchange="applyFilters()" class="food-select bg-white text-orange-600 text-sm font-bold rounded px-2 py-1 focus:outline-none shadow-sm cursor-pointer w-24">
                            <option value="3.0">3.0 ⭐</option>
                            <option value="3.5">3.5 ⭐</option>
                            <option value="3.8" selected>3.8 ⭐</option>
                            <option value="4.0">4.0 ⭐</option>
                            <option value="4.2">4.2 ⭐</option>
                            <option value="4.5">4.5 ⭐</option>
                        </select>
                    </div>

                    <div class="flex items-center space-x-2">
                        <label for="distance-select" class="text-sm font-medium text-white/90 whitespace-nowrap">
                            <i class="fas fa-ruler-horizontal text-blue-200 mr-1"></i>距離
                        </label>
                        <select id="distance-select" onchange="applyFilters()" class="food-select bg-white text-orange-600 text-sm font-bold rounded px-2 py-1 focus:outline-none shadow-sm cursor-pointer w-24">
                            <option value="0.5">0.5 km</option>
                            <option value="1.0" selected>1.0 km</option>
                            <option value="2.0">2.0 km</option>
                            <option value="3.0">3.0 km</option>
                            <option value="5.0">5.0 km</option>
                        </select>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Content Area (Food) -->
        <main class="flex-grow overflow-y-auto p-4 pb-24" id="main-container">
            <div class="max-w-2xl mx-auto w-full">
                <!-- Status Message -->
                <div id="status-msg" class="mb-4 text-center text-sm text-gray-500 hidden flex items-center justify-center gap-2">
                    <i class="fas fa-map-marker-alt"></i> <span id="location-text">定位中...</span>
                </div>

                <!-- Categories Tabs -->
                <div class="sticky top-0 bg-[#f3f4f6] pt-2 pb-4 z-10 category-scroll gap-2 mb-2 hidden" id="category-tabs"></div>

                <!-- Content Container -->
                <div id="content-area" class="space-y-6"></div>
            </div>
        </main>

        <!-- Loading Overlay (Food) -->
        <div id="loading-overlay" class="absolute inset-0 bg-white z-20 flex flex-col items-center justify-center hidden">
            <div class="w-16 h-16 border-4 border-orange-200 border-t-orange-500 rounded-full animate-spin mb-4"></div>
            <p class="text-gray-600 font-medium animate-pulse">正在搜尋周邊美食...</p>
            <p class="text-xs text-gray-400 mt-2">智慧模擬定位中...</p>
        </div>
    </div>

    <!-- ========================================== -->
    <!-- 底部功能選單 (Bottom Navigation) -->
    <!-- ========================================== -->
    <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)] z-50 pb-safe">
        <div class="flex justify-around items-center h-16">
            <button onclick="switchApp('ev')" id="nav-ev" class="flex-1 flex flex-col items-center justify-center h-full text-green-600 transition-colors duration-200">
                <i class="fas fa-charging-station text-xl mb-1"></i>
                <span class="text-xs font-medium">充電導航</span>
            </button>
            <button onclick="switchApp('food')" id="nav-food" class="flex-1 flex flex-col items-center justify-center h-full text-gray-400 hover:text-orange-500 transition-colors duration-200">
                <i class="fas fa-utensils text-xl mb-1"></i>
                <span class="text-xs font-medium">美食決策</span>
            </button>
        </div>
    </nav>

    <!-- No Results Template (Food) -->
    <template id="no-results-template">
        <div class="text-center py-10 text-gray-400 fade-in">
            <i class="fas fa-search fa-3x mb-3 opacity-30"></i>
            <p>哎呀！這個範圍內找不到符合條件的餐廳。</p>
            <p class="text-xs mt-2 opacity-70">試試看放寬距離或降低評分標準？</p>
        </div>
    </template>

    <script>
        // --- 全域變數與切換邏輯 ---
        let currentApp = 'ev';
        let isFoodAppInitialized = false;

        function switchApp(appName) {
            const evView = document.getElementById('view-ev');
            const foodView = document.getElementById('view-food');
            const navEv = document.getElementById('nav-ev');
            const navFood = document.getElementById('nav-food');

            if (appName === 'ev') {
                evView.classList.remove('hidden');
                foodView.classList.add('hidden');
                
                // 更新導航樣式
                navEv.classList.remove('text-gray-400');
                navEv.classList.add('text-green-600');
                navFood.classList.remove('text-orange-600');
                navFood.classList.add('text-gray-400');
            } else if (appName === 'food') {
                evView.classList.add('hidden');
                foodView.classList.remove('hidden');
                
                // 更新導航樣式
                navFood.classList.remove('text-gray-400');
                navFood.classList.add('text-orange-600');
                navEv.classList.remove('text-green-600');
                navEv.classList.add('text-gray-400');

                // 首次切換到美食時，才啟動初始化
                if (!isFoodAppInitialized) {
                    initApp();
                    isFoodAppInitialized = true;
                }
            }
        }

        // ==========================================
        // EV 充電站功能程式碼 (保留原功能)
        // ==========================================
        const MOCK_BRANDS = [
            { name: "EVOASIS 超充站", basePrice: 8.4, peakPrice: 10.5, type: "DC 180kW" },
            { name: "U-POWER 極速充電", basePrice: 9.0, peakPrice: 11.0, type: "DC 360kW" },
            { name: "特爾電力 TAIL", basePrice: 9.5, peakPrice: 12.0, type: "DC 200kW" },
            { name: "EVALUE 華城", basePrice: 8.0, peakPrice: 10.0, type: "DC 120kW" },
            { name: "公有停車場慢充", basePrice: 7.5, peakPrice: 7.5, type: "AC 7kW" }
        ];

        const MOCK_STREETS_EV = [
            "中正路", "中山路", "復興路", "三民路", "民族路", 
            "文化路", "大業路", "信義路", "和平東路", "建國北路",
            "長安街", "集賢路", "三和路", "光復路"
        ];

        function startLocationProcess() {
            const btn = document.getElementById('locate-btn');
            const statusText = document.getElementById('status-text');
            const errorContainer = document.getElementById('error-container');
            
            btn.disabled = true;
            btn.innerHTML = '<div class="loader"></div> 定位中...';
            statusText.innerText = "正在取得 GPS...";
            errorContainer.classList.add('hidden');

            if (!navigator.geolocation) {
                handleError("此瀏覽器不支援定位");
                return;
            }

            const options = {
                enableHighAccuracy: false, 
                timeout: 15000,
                maximumAge: 60000
            };

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const userLat = position.coords.latitude;
                    const userLng = position.coords.longitude;
                    statusText.innerText = "已鎖定位置";
                    generateAndRenderStations(userLat, userLng);
                    btn.innerHTML = '<i class="fas fa-sync-alt"></i> 重新搜尋';
                    btn.disabled = false;
                },
                (error) => {
                    let msg = `定位失敗 (代碼:${error.code})`;
                    switch(error.code) {
                        case error.PERMISSION_DENIED: msg = "定位權限被網站拒絕。"; break;
                        case error.POSITION_UNAVAILABLE: msg = "無法偵測位置。"; break;
                        case error.TIMEOUT: msg = "定位回應逾時。"; break;
                    }
                    handleError(msg);
                },
                options
            );
        }

        function useDefaultLocation() {
            const btn = document.getElementById('locate-btn');
            const statusText = document.getElementById('status-text');
            const errorContainer = document.getElementById('error-container');
            errorContainer.classList.add('hidden');
            statusText.innerText = "使用預設位置 (蘆洲)";
            const defaultLat = 25.08;
            const defaultLng = 121.47;
            generateAndRenderStations(defaultLat, defaultLng);
            btn.innerHTML = '<i class="fas fa-sync-alt"></i> 重新搜尋';
            btn.disabled = false;
        }

        function handleError(msg) {
            const btn = document.getElementById('locate-btn');
            const statusText = document.getElementById('status-text');
            const errorContainer = document.getElementById('error-container');
            const errorMsg = document.getElementById('error-msg');
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-location-arrow"></i> 再試一次';
            statusText.innerText = "定位失敗";
            errorMsg.innerText = msg;
            errorContainer.classList.remove('hidden');
        }

        function generateAndRenderStations(userLat, userLng) {
            document.getElementById('empty-state').classList.add('hidden');
            document.getElementById('result-container').classList.remove('hidden');
            const listContainer = document.getElementById('station-list');
            listContainer.innerHTML = ''; 

            let stations = [];
            for (let i = 0; i < 10; i++) {
                const brand = MOCK_BRANDS[i % MOCK_BRANDS.length];
                const offsetLat = (Math.random() - 0.5) * 0.04; 
                const offsetLng = (Math.random() - 0.5) * 0.04;
                const street = MOCK_STREETS_EV[Math.floor(Math.random() * MOCK_STREETS_EV.length)];
                const num = Math.floor(Math.random() * 300) + 1;
                const section = Math.random() > 0.5 ? `${Math.floor(Math.random()*3)+1}段` : "";
                
                stations.push({
                    id: i,
                    name: `${brand.name} (站點 ${String.fromCharCode(65+i)})`,
                    lat: userLat + offsetLat,
                    lng: userLng + offsetLng,
                    price: brand.basePrice,
                    type: brand.type,
                    brandType: brand.name.includes("公有") ? "slow" : "fast",
                    address: `新北市蘆洲區${street}${section}${num}號`
                });
            }

            stations.forEach(station => {
                station.distance = calculateHaversineDistance(userLat, userLng, station.lat, station.lng);
            });
            stations.sort((a, b) => a.distance - b.distance);
            stations.forEach((station, index) => {
                listContainer.appendChild(createStationCard(station, index));
            });
        }

        function calculateHaversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(1);
        }

        function createStationCard(station, index) {
            const div = document.createElement('div');
            div.className = "bg-white rounded-xl shadow-sm p-4 flex flex-col gap-3 border border-gray-100 fade-in";
            div.style.animationDelay = `${index * 0.1}s`;
            const iconClass = station.brandType === 'fast' ? 'bg-orange-100 text-orange-600' : 'bg-blue-100 text-blue-600';
            const icon = station.brandType === 'fast' ? 'fa-bolt' : 'fa-plug';

            div.innerHTML = `
                <div class="flex justify-between items-start">
                    <div class="flex gap-3">
                        <div class="w-10 h-10 rounded-lg ${iconClass} flex items-center justify-center flex-shrink-0">
                            <i class="fas ${icon}"></i>
                        </div>
                        <div>
                            <h4 class="font-bold text-lg text-gray-800 leading-tight">${station.name}</h4>
                            <div class="text-sm text-gray-500 mt-1">
                                <span class="bg-gray-100 px-2 py-0.5 rounded text-xs font-medium">${station.type}</span>
                                <span class="ml-2"><i class="fas fa-map-marker-alt text-gray-400"></i> ${station.distance} km</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-xl font-bold text-green-600">$${station.price}</div>
                        <div class="text-xs text-gray-400">/度 (kWh)</div>
                    </div>
                </div>
                <div class="text-sm text-gray-600 mt-2 flex items-center px-1">
                    <i class="fas fa-map-pin w-5 text-center mr-1 text-red-400"></i>
                    <span class="truncate">${station.address}</span>
                </div>
                <div class="mt-2 pt-3 border-t border-gray-100 flex gap-2">
                    <a href="https://www.google.com/maps/dir/?api=1&destination=${station.lat},${station.lng}" target="_blank" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white text-center py-2 rounded-lg font-medium transition flex items-center justify-center gap-2">
                        <i class="fas fa-location-arrow"></i> 立即導航
                    </a>
                </div>
            `;
            return div;
        }

        // ==========================================
        // 美食決策導航功能程式碼 (新功能)
        // ==========================================
        const FOOD_CONFIG = {
            categories: {
                'chinese': { name: '中式料理', icon: 'fa-bowl-rice', color: 'bg-red-100 text-red-600' },
                'japanese': { name: '日式料理', icon: 'fa-fish', color: 'bg-blue-100 text-blue-600' },
                'western': { name: '西式/速食', icon: 'fa-burger', color: 'bg-yellow-100 text-yellow-600' },
                'cafe': { name: '咖啡/甜點', icon: 'fa-mug-hot', color: 'bg-amber-100 text-amber-700' },
                'snack': { name: '在地小吃', icon: 'fa-cookie-bite', color: 'bg-orange-100 text-orange-600' }
            }
        };

        let foodUserLocation = null;
        let allRestaurants = [];

        function deg2rad(deg) { return deg * (Math.PI/180); }

        function getFoodDistance(lat1, lon1, lat2, lon2) {
            return parseFloat(calculateHaversineDistance(lat1, lon1, lat2, lon2)); // Reuse existing math function
        }

        function formatDistance(km) {
            if (km < 1) return `${Math.round(km * 1000)}m`;
            return `${km.toFixed(1)}km`;
        }

        async function reverseGeocode(lat, lon) {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 2000);
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}&zoom=14&accept-language=zh-TW`, { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error('API Error');
                const data = await response.json();
                const addr = data.address;
                const city = addr.city || addr.county || '';
                const district = addr.suburb || addr.town || addr.district || '';
                if (city || district) return `${city}${district}`;
                return null;
            } catch (error) {
                return null;
            }
        }

        function generateMockFoodData(centerLat, centerLon, areaPrefix) {
            const mockData = [];
            const names = {
                'chinese': ['老張牛肉麵', '鼎泰豐味', '阿嬤私房菜', '川味小館', '北方麵食館', '豪大雞排', '巷口熱炒', '御品烤鴨', '鬍鬚張魯肉飯', '四海遊龍', '八方雲集', '欣葉台菜', '這一鍋麻辣', '老四川', '三媽臭臭鍋', '大呼過癮', '錢都日式涮涮鍋', '石二鍋', '爭鮮迴轉壽司', '梁社漢排骨', '悟饕池上飯包', '海底撈火鍋', '王品牛排', '陶板屋'],
                'japanese': ['壽司郎', '藏壽司', '一蘭拉麵', '屯京拉麵', '博多拉麵', '勝博殿炸豬排', '杏子日式豬排', '大戶屋', '彌生軒', '吉野家', 'Sukiya食其家', '松屋', '定食8', '花月嵐拉麵', '丸龜製麵', '牛角燒肉', '乾杯燒肉', '欣葉日本料理', '点爭鮮', 'HAMA壽司', '三田製麵所'],
                'western': ['Luigi Pizza', 'Tasty Burger', 'Corner Cafe', 'Friday Night Bistro', 'The Steak House', 'Good Morning Brunch', '麥當勞', '肯德基 KFC', '必勝客 Pizza Hut', '達美樂 Domino', '摩斯漢堡 MOS', '漢堡王', 'Subway', '21世紀風味館', '金色三麥', '貳樓餐廳', 'TGI Fridays', 'Chili\'s', 'GB鮮釀餐廳', 'Texas Roadhouse', 'N.Y. Bagels'],
                'cafe': ['星巴克 Starbucks', '路易莎咖啡 Louisa', '85度C', 'Cama Café', '丹堤咖啡', '怡客咖啡', '春水堂', '天仁茗茶', '50嵐', '迷客夏', '可不可熟成紅茶', 'CoCo都可', '麻古茶坊', '五桐號', '龜記茗品', '清心福全', '茶湯會', '珍煮丹', '老虎堂', '幸福堂', '伯朗咖啡', '多那之咖啡'],
                'snack': ['阿明麵線', '脆皮臭豆腐', '基隆甜不辣', '彰化肉圓', '古早味豆花', '爆漿雞蛋糕', '大腸包小腸', '豪大雞排', '繼光香香雞', '派克雞排', '阿宗麵線', '柯氏蔥油餅', '宜蘭蔥餅', '晴光紅豆餅', '師園鹽酥雞', '胖老爹美式炸雞', '阿給老店', '深坑臭豆腐', '燈籠滷味', '老天祿滷味', '洪瑞珍三明治']
            };
            const streets = ['中正路', '中山路', '中華路', '民生路', '復興路', '自由路', '大同路', '建國路', '和平路', '信義路', '仁愛路', '忠孝路', '南京東路', '林森北路'];
            const types = Object.keys(FOOD_CONFIG.categories);
            let idCounter = 0;

            types.forEach(type => {
                const typeNames = names[type];
                // 保底優質數據
                for (let i = 0; i < 12 && i < typeNames.length; i++) {
                    const latOffset = (Math.random() - 0.5) * 0.015;
                    const lonOffset = (Math.random() - 0.5) * 0.015;
                    const name = typeNames[i] + (Math.random() > 0.7 ? " (總店)" : "");
                    const street = streets[Math.floor(Math.random() * streets.length)];
                    const section = Math.random() > 0.6 ? `${Math.floor(Math.random()*4)+1}段` : '';
                    const number = Math.floor(Math.random() * 300) + 1;
                    const address = `${areaPrefix}${street}${section}${number}號`;
                    const rating = (Math.random() * 1.0 + 4.0).toFixed(1);
                    const reviews = Math.floor(Math.random() * 2000) + 200;

                    mockData.push({
                        id: idCounter++, name, type, lat: centerLat + latOffset, lng: centerLon + lonOffset, address, rating: parseFloat(rating), reviews, isOpen: Math.random() > 0.1
                    });
                }
                // 隨機廣域數據
                for (let i = 12; i < typeNames.length && i < 25; i++) {
                    const latOffset = (Math.random() - 0.5) * 0.1;
                    const lonOffset = (Math.random() - 0.5) * 0.1;
                    const name = typeNames[i] + (Math.random() > 0.5 ? " (分店)" : "");
                    const street = streets[Math.floor(Math.random() * streets.length)];
                    const section = Math.random() > 0.6 ? `${Math.floor(Math.random()*4)+1}段` : '';
                    const number = Math.floor(Math.random() * 500) + 1;
                    const address = `${areaPrefix}${street}${section}${number}號`;
                    const rating = (Math.random() * 1.3 + 3.5).toFixed(1);
                    const reviews = Math.floor(Math.random() * 1000) + 50;

                    mockData.push({
                        id: idCounter++, name, type, lat: centerLat + latOffset, lng: centerLon + lonOffset, address, rating: parseFloat(rating), reviews, isOpen: Math.random() > 0.2
                    });
                }
            });
            return mockData;
        }

        async function initApp() {
            const loadingOverlay = document.getElementById('loading-overlay');
            const statusMsg = document.getElementById('status-msg');
            const locationText = document.getElementById('location-text');
            const contentArea = document.getElementById('content-area');
            const tabsArea = document.getElementById('category-tabs');

            loadingOverlay.classList.remove('hidden');
            contentArea.innerHTML = '';
            tabsArea.classList.add('hidden'); 
            
            let areaName = "台北市中正區"; 

            try {
                const position = await getFoodPosition();
                foodUserLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                
                const fetchedArea = await reverseGeocode(foodUserLocation.lat, foodUserLocation.lng);
                if (fetchedArea) areaName = fetchedArea;

                statusMsg.classList.remove('hidden');
                locationText.innerText = `目前位置: ${foodUserLocation.lat.toFixed(4)}, ${foodUserLocation.lng.toFixed(4)} (${areaName}周邊)`;
                locationText.className = "text-green-600 font-medium";

                const rawData = generateMockFoodData(foodUserLocation.lat, foodUserLocation.lng, areaName);
                rawData.forEach(item => {
                    item.distance = getFoodDistance(foodUserLocation.lat, foodUserLocation.lng, item.lat, item.lng);
                });
                
                allRestaurants = rawData;
                applyFilters();

            } catch (error) {
                foodUserLocation = { lat: 25.0478, lng: 121.5170 };
                areaName = "台北市中正區";
                statusMsg.classList.remove('hidden');
                locationText.innerText = `無法定位，已切換至預設位置 (${areaName})`;
                locationText.className = "text-orange-600 font-medium";

                const rawData = generateMockFoodData(foodUserLocation.lat, foodUserLocation.lng, areaName);
                rawData.forEach(item => {
                    item.distance = getFoodDistance(foodUserLocation.lat, foodUserLocation.lng, item.lat, item.lng);
                });
                allRestaurants = rawData;
                applyFilters();
            } finally {
                setTimeout(() => {
                    loadingOverlay.classList.add('hidden');
                    tabsArea.classList.remove('hidden'); 
                }, 800);
            }
        }

        function getFoodPosition() {
            return new Promise((resolve, reject) => {
                if (!navigator.geolocation) reject(new Error("Browser does not support geolocation"));
                else navigator.geolocation.getCurrentPosition(resolve, reject, { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 });
            });
        }

        function applyFilters() {
            const minRating = parseFloat(document.getElementById('rating-select').value);
            const maxDistance = parseFloat(document.getElementById('distance-select').value);
            
            const filtered = allRestaurants.filter(item => item.distance <= maxDistance && item.rating >= minRating);

            const categorized = { 'chinese': [], 'japanese': [], 'western': [], 'cafe': [], 'snack': [] };

            filtered.forEach(item => {
                if (categorized[item.type]) categorized[item.type].push(item);
            });

            for (let key in categorized) {
                categorized[key].sort((a, b) => b.rating - a.rating);
                categorized[key] = categorized[key].slice(0, 10);
            }
            renderUI(categorized);
        }

        function renderUI(data) {
            const container = document.getElementById('content-area');
            const tabsContainer = document.getElementById('category-tabs');
            
            container.innerHTML = '';
            tabsContainer.innerHTML = '';

            const totalItems = Object.values(data).reduce((acc, curr) => acc + curr.length, 0);
            if (totalItems === 0) {
                const template = document.getElementById('no-results-template');
                container.appendChild(template.content.cloneNode(true));
                return;
            }

            Object.keys(FOOD_CONFIG.categories).forEach((key, index) => {
                const items = data[key];
                if (items.length === 0) return;
                const catConfig = FOOD_CONFIG.categories[key];

                const tabBtn = document.createElement('a');
                tabBtn.href = `#cat-${key}`;
                tabBtn.className = `flex-none px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition shadow-sm border border-gray-100 ${index === 0 ? 'bg-orange-600 text-white' : 'bg-white text-gray-600 hover:bg-gray-50'}`;
                tabBtn.innerHTML = `<i class="fas ${catConfig.icon} mr-1"></i>${catConfig.name} <span class="ml-1 text-xs opacity-70">(${items.length})</span>`;
                tabBtn.onclick = (e) => {
                    document.querySelectorAll('#category-tabs a').forEach(el => {
                        el.className = 'flex-none px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition shadow-sm border border-gray-100 bg-white text-gray-600 hover:bg-gray-50';
                    });
                    e.currentTarget.className = 'flex-none px-4 py-2 rounded-full text-sm font-medium whitespace-nowrap transition shadow-sm border border-gray-100 bg-orange-600 text-white';
                };
                tabsContainer.appendChild(tabBtn);

                const section = document.createElement('section');
                section.id = `cat-${key}`;
                section.className = 'fade-in scroll-mt-20'; 

                const titleDiv = document.createElement('div');
                titleDiv.className = 'flex items-center mb-3 px-1';
                titleDiv.innerHTML = `<div class="w-1 h-6 bg-orange-500 rounded-full mr-3"></div><h2 class="text-lg font-bold text-gray-800">${catConfig.name}</h2><span class="ml-auto text-xs font-semibold px-2 py-1 rounded bg-gray-200 text-gray-600">Top ${items.length}</span>`;
                section.appendChild(titleDiv);

                items.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-xl p-4 shadow-sm border border-gray-100 mb-3 flex flex-col hover:shadow-md transition';
                    const ratingColor = item.rating >= 4.5 ? 'text-orange-500' : 'text-yellow-500';
                    const distanceBadge = item.distance < 0.3 ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full font-medium">步行可達</span>' : '';
                    const navUrl = `https://www.google.com/maps/dir/?api=1&destination=${item.lat},${item.lng}`;

                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-2">
                            <div>
                                <h3 class="font-bold text-lg text-gray-800 leading-tight">${item.name}</h3>
                                <div class="flex items-center mt-1 text-sm mb-1">
                                    <span class="${ratingColor} font-bold mr-1">${item.rating}</span>
                                    <div class="text-xs text-gray-300 mr-2 flex">${getStars(item.rating)}</div>
                                    <span class="text-xs text-gray-400">(${item.reviews} 則評論)</span>
                                </div>
                                <div class="text-xs text-gray-500 flex items-center">
                                    <i class="fas fa-map-pin mr-1 opacity-70 w-3 text-center"></i>${item.address}
                                </div>
                            </div>
                            <span class="text-xs font-bold text-gray-500 bg-gray-100 px-2 py-1 rounded whitespace-nowrap ml-2">${formatDistance(item.distance)}</span>
                        </div>
                        <div class="flex items-center justify-between mt-2 pt-3 border-t border-gray-50 border-dashed">
                            <div class="flex gap-2">
                                ${distanceBadge}
                                ${item.isOpen ? '<span class="text-xs text-gray-500 flex items-center"><i class="fas fa-clock mr-1 text-green-500"></i>營業中</span>' : '<span class="text-xs text-gray-400">休息中</span>'}
                            </div>
                            <a href="${navUrl}" target="_blank" class="bg-blue-600 hover:bg-blue-700 active:bg-blue-800 text-white text-sm font-medium px-4 py-2 rounded-lg flex items-center shadow-sm transition transform active:scale-95">
                                <i class="fas fa-location-arrow mr-2"></i> 出發
                            </a>
                        </div>
                    `;
                    section.appendChild(card);
                });
                container.appendChild(section);
            });
        }

        function getStars(rating) {
            let stars = '';
            for (let i = 1; i <= 5; i++) {
                if (i <= rating) stars += '<i class="fas fa-star text-orange-400"></i>';
                else if (i - 0.5 <= rating) stars += '<i class="fas fa-star-half-alt text-orange-400"></i>';
                else stars += '<i class="far fa-star text-gray-300"></i>';
            }
            return stars;
        }
    </script>
</body>
</html>
